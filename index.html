<!doctype HTML>
<html>
<head>
	<style>
	.group:after{
		content:"";
		display:block;
		clear:both;
	}
	
	section.campaign-lookup{
		float: left;
		width: 500px;
	}
	
	section.campaigns{
		float: right;
		width: 700px;
		background: red;
	}
	
	.hidden{
		display: none;
	}
	
	.container{
		width: 1200px;
		margin: auto;
		position: relative;
	}
	
	#success-message, #error-message{
		position: absolute;
		background: white;
		border: 1px solid black;
		border-radius: 15px;
		padding: 20px;
		top: 200px;
		z-index: 2;
	}
	
	#success-message{
		left: 400px;
	}
	
	#error-message{
		left: 450px;
	}
	
	.black-overlay{
	  display: none;
	  position: absolute;
	  top: 0;
	  left: 0;
	  width: 100%;
	  height: 100%;
	  background-color: black;
	  z-index: 1;
	  opacity: 0.6;
	}
	
	li{
		list-style:none;
	}
	
	li.campaign-header{
		background: gray;
	}
	
	li.campaign-header ul li{
		float: left;
		padding-left: 40px;
	}
	
	li.campaign-header ul li:nth-child(1){
		padding-left:0;
	}
	
	</style>
</head>
<body>
	<div class="container">
		<section class="campaign-lookup">
			<form id="campaign-selector">
				<label for="agency-selector">Agency</label>
				<select id="agency-selector">
					<option value="no-choice">Choose an agency...</option>
				</select>
				<label for="advertiser-selector">Advertiser</label>
				<select id="advertiser-selector" disabled="true">
					<option value="no-choice">Choose an advertiser...</option>
				</select>
				<button id="get-campaigns" disabled="true">Get Campaigns</button>
			</form>
		</section>
		<section class="campaigns">
			<ul class="campaign-list">
				<li class="campaign-header group">
					<ul>
						<li><input type="checkbox"></li>
						<li>Campaign Name</li>
						<li>Status</li>
						<li>Budget</li>
						<li>Start Date</li>
						<li>End Date</li>
					</ul>
				</li>
			</ul>
			<button id="save-campaigns">Save</button>
		</section>
		<div class="messages">
			<div id="success-message" class="hidden">
				<h2>Success!</h2>
				<p>
					All selected campaigns have been successfully updated!
				</p>
				<button id="success-ok">Ok</button>
			</div>
			<div id="error-message" class= "hidden">
				<h2>Error!</h2>
				<p>
					There was an error saving your campaigns.
				</p>
				<button id="error-ok">Ok</button>
			</div>
		</div>
	</div>
	<div class="black-overlay"></div>
</body>
</html>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>

<script type="text/javascript">
$(document).ready(function() {
	
	var populateAgencySelect = function() {
		var req = $.ajax({
			url: 'http://challenge.mediamath.com/api/agencies?api_token=c3ac5cdb9e79c59ec617345970c9a399880516ef'
		})
		
		var updateAgencySelect = function(resp) {
			_.each(resp.agencies, function(agency,index){
				var $agencyOption = $('<option></option>')
				$agencyOption.attr("value",agency._id)
				$agencyOption.html(agency.name)
				$('#agency-selector').append($agencyOption)
			})
		}
		
		var error = function(req,status,error){
			console.log(error)
		}
		
		req.then(updateAgencySelect, error)
	}
	
	var populateAdvertiserSelect = function(agencyId) {
		$('#advertiser-selector').html("<option value='no-choice'>Choose an advertiser...</option")
		
		var req = $.ajax({
			url: 'http://challenge.mediamath.com/api/advertisers?api_token=c3ac5cdb9e79c59ec617345970c9a399880516ef',
		})
		
		var updateAdvertiserSelect = function(resp){
			var agencyAdvertisers = _.where(resp.advertisers, {agency_id: agencyId})
			
			_.each(agencyAdvertisers, function(advertiser,index){
				var $advertiserOption = $('<option></option>')
				$advertiserOption.attr("value",advertiser._id)
				$advertiserOption.html(advertiser.name)
				$('#advertiser-selector').append($advertiserOption)
			})
			enableElement($('#advertiser-selector'))
		}
		
		var error = function(req,status,error){
			console.log(error)
		}
		
		req.then(updateAdvertiserSelect, error)
	}
	
	var populateCampaigns = function(advertiserId){
		var req = $.ajax({
			url: 'http://challenge.mediamath.com/api/campaigns?api_token=c3ac5cdb9e79c59ec617345970c9a399880516ef'
		})
		
		var $campaignList = $('.campaign-list')
		
		var renderCampaigns = function (resp) {
			var $campaignHeader = $('.campaign-header').clone()
			$('.campaign-list').empty()
			$('.campaign-list').append($campaignHeader)
			
			var advertiserCampaigns = _.where(resp.campaigns, {advertiser_id: advertiserId})
			_.each(advertiserCampaigns,function(campaign){
				$campaignLi = $('<li></li>').addClass('campaign')
				$campaignLi.attr("data-id",campaign._id)
				$campaignLi.html(buildCampaignForm(campaign))
				$campaignList.append($campaignLi)
			})
		}
		
		var error = function(req,status,error){
			console.log(error)
		}
		
		req.then(renderCampaigns,error)
	}
	
	var buildCampaignForm = function(campaign) {
		var $form = $('<form></form>')
		var $checkbox = $('<input type="checkbox" id="to-update" checked></input>')
		var $name = $('<input type="text" name="campaign-name"></input>')
		var $status = $('<select name="campaign-status"></select>')
		var $budget = $('<input type="number" name="campaign-budget"></input>')
		var $startDate = $('<input type="text" name="campaign-start-date"></input>')
		var $endDate = $('<input type="text" name="campaign-end-date"></input>')
		
		$status.append($('<option value="true">Active</input>'))
		$status.append($('<option value="false">Inactive</input>'))
		
		$form.attr("data-id", campaign._id)
		$name.attr("value", campaign.name)
		campaign.status ? $status.attr("value", true) : $status.attr("value", false)
		$budget.attr("value", campaign.budget)
		$startDate.attr("value", campaign.start_date)
		$endDate.attr("value", campaign.end_date)
		
		$form.append($checkbox, [$name, $status, $budget, $startDate, $endDate])
		
		return $form
	}
	
	var updateCampaigns = function() {
		var $campaigns = $('.campaign-list').find('input:checked').parent()
		_.each($campaigns,function(campaign,index,list){
			var $formData = $(campaign).serialize()
			var campaignId = $(campaign).attr("data-id")
			$.ajax({
				url: 'http://challenge.mediamath.com/api/campaigns/' + campaignId + '/?api_token=c3ac5cdb9e79c59ec617345970c9a399880516ef',
				type: 'post',
				data: $formData,
				success: function(data,status,jqXHR){
					showSuccessMessage();
				},
				error: function(req,status,err){
					console.log(err)
				}
			})
		})
	}
	
	var showSuccessMessage = function(){
		$('#success-message').removeClass('hidden');
		$('.black-overlay').css('display', 'block');
	}
	
	$('#agency-selector').on('change', function(event){
		var selectedAgencyId = $(event.currentTarget).find(":selected").attr("value")
		selectedAgencyId === "no-choice" ? disableAdvertiserSelector() : populateAdvertiserSelect(selectedAgencyId)
	})
	
	$('#advertiser-selector').on('change', function(event){
		var selectedAdvertiserId = $(event.currentTarget).find(":selected").attr("value")
		selectedAdvertiserId === "no-choice" ? disableElement($('button#get-campaigns')) : enableElement($('button#get-campaigns'))
	})
	
	$('button#get-campaigns').on('click', function(event){
		event.preventDefault();
		var selectedAdvertiserId = $(event.currentTarget).parent().find('#advertiser-selector').find(':selected').attr("value")
		populateCampaigns(selectedAdvertiserId)
	})
	
	$('button#save-campaigns').on('click', function(event){
		event.preventDefault();
		updateCampaigns();
	})
	
	$('.messages').on('click', 'button', function(event){
		$('.black-overlay').css('display', 'none');
		$(event.currentTarget).parent().addClass('hidden')
	})
	
	var disableAdvertiserSelector = function() {
		disableElement($('#advertiser-selector'))
		$('#advertiser-selector').html("<option value='no-choice'>Choose an advertiser...</option").trigger("change")
	}
	
	var disableElement = function($el){
		$el.attr("disabled", true)
	}
	
	var enableElement = function($el){
		$el.attr("disabled", false)
	}
	
	populateAgencySelect();
})
</script>